const { MongoClient } = require('mongodb');
const { APP_DETAILS_DIR } = require('server/config');
const fs = require('fs');
const path = require('path');

const main = async (uri) => {
  if (!uri) {
    console.log('Missing required argument: MongoDB URI');
    return;
  }
  console.info(`Connecting to MongoDB URI: ${uri}`);
  const db = await MongoClient.connect(uri);
  // TODO: Remove items in DB that aren't in local data files
  try {
    const collection = await db.collection('appDetails');
    console.log(Object.getPrototypeOf(collection));
    return;
    const filePaths = fs.readdirSync(APP_DETAILS_DIR)
      .filter(name => !name.startsWith('.'))
      .map(name => path.join(APP_DETAILS_DIR, name));
    for (const filePath of filePaths) {
      const contents = fs.readFileSync(filePath);
      const data = JSON.parse(contents);
      if (data) {
        continue;
      } else {
        const _id = filePath.match(/\d+\.json$/)[0].replace('.json', '');
        collection.removeOne({_id})
      }
      // Set ID param for MongoDB
      data._id = data.steam_appid.toString();
    }
  } finally {
    db.close();
  }
}

// Skip first arg (path to Node) and second arg (path to script)
const args = process.argv.slice(2);

main(...args).catch((e) => console.error(e));
